<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    <title>Title</title>
</head>
<body>
<div class="input-group flex-nowrap" style="width: 50%; padding-top: 20px; margin: auto">
    <span class="input-group-text">댓글내용</span>
    <input name="replyText" class="form-control replyText">
    <span class="input-group-text">작성자</span>
    <input name="replyer" class="form-control replyer">
    <button type="button" class="btn btn-primary saveBtn">Save</button>


</div>
        <div class="panel-body" style="padding-top: 30px;">
            <ul class="list-group replylist">
                <li class="list-group-item">
                    <strong></strong>
                    <small></small>
                    <p></p>
                </li>
            </ul>
        </div>
<div class="modal">
        <div>
            <label class="replyText1">내용</label>
            <input class="form-control replyText replyText1" id="replyText">
            <label class="replyer1">작성자</label>
            <input class="form-control replyer replyer1">
            <label class="regDate1">등록일자</label>
            <input class="form-control regDate regDate1">
        </div>
        <div>
            <button type="button" class="modBtn">Modify</button>
            <button type="button" class="removeBtn">remove</button>
        </div>
</div>

    </div>
<script th:inline="javascript">

    let saveBtn = $(".saveBtn")
    let modBtn = $(".modBtn")
    let removeBtn = $(".removeBtn")
    let replyText = $(".replyText")
    let replyer = $(".replyer")
    let regDate = $(".regDate")
    let replylist = $(".replylist")
    let replyText1 = $(".replyText1")
    let replyer1 = $(".replyer1")
    let regDate1 = $(".regDate1")

    let str = "";
    let str2 = "";
    let pagination = $(".pagination")
    let modal = $(".modal")

    removeBtn.on("click", function (e){
        console.log(modal.data("rno"))
        $.ajax({
            url : "/replies/remove/" + modal.data("rno"),
            type : "delete",
            dataType: "json",
            success : function (data){
                alert(data.rno + " 번 댓글이 삭제되었습니다")
                replyRead(1)
            }
        })
    })

    modBtn.on("click", function (e){
        let reply = {"rno" : modal.data("rno"), "replyText" : $("#replyText").val()}
        console.log(reply.replyText)
        $.ajax({
            url : "/replies/modify/" + reply.rno,
            data : JSON.stringify(reply),
            type : 'put',
            contentType: "application/json; charset=utf-8",
            success : function (data){
                console.log(data)
                alert(data.rno + " 번 댓글이 수정되었습니다")
                replyRead(1)
            },
            error : function (result, status, error){
                console.log(result.status + '' + result.error())
            }
        })
    })


    saveBtn.on("click", function (e){
        let reply = {"bno" : 11, "replyText" : replyText.val(), "replyer" : replyer.val()}
        console.log(reply)
            $.ajax({
                url : "/replies/new",
                type : "post",
                data : JSON.stringify(reply),
                contentType : "application/json; charset=utf-8",
                dataType : "json",
                success : function (data){
                    console.log(data)
                    alert(data.rno + " 번 댓글이 등록되었습니다")
                    replyRead(1)
                }
            })
    })
        let replyRead = function (page) {
            str = "";
            str2 = "";
            $.getJSON("/replies/list/11", function (data) {
                console.log(data)
                for (let i = 0; i < data.dtoList.length; i++) {
                    str += `<li class="list-group-item" data-num="${data.dtoList[i].rno}"><strong>${data.dtoList[i].replyer}</strong>
                    <small>${data.dtoList[i].regDate}</small><p>${data.dtoList[i].replyText}</p></li>`
                }
                if(data.prev){
                    str2 += `<li  class="paginate_button previous " aria-controls="dataTables-example" tabindex="0" id="dataTables-example_previous">
                <a data-num="${data.start -1}">이전</a>
            </li>`;
                }
                for(let i = data.start, j=data.end ; i <= j ; i++){
                    str2 +=  `<li class="paginate_button ${i == data.page ? 'active' : ''}" aria-controls="dataTables-example" tabIndex="0">
                    <a data-num="${i}">${i}</a>
                </li>`;

                }
                if(data.next) {
                    str2 += `<li  class="paginate_button" aria-controls="dataTables-example" tabindex="0" id="dataTables-example_next">
                <a data-num="${data.end + 1}">Next</a>
            </li>`
                }
                pagination.html(str2)
                replylist.html(str)

            })
        }

        pagination.on("click", "a", function (e){
            let target = $(e.target).data("num")
            replyRead(target)
        })

        replyRead(1)

    replylist.on("click", "li", function (e){
        replyText.val("")
        replyer.val("")
        regDate.val("")
        replyText1.show()
        replyer1.show()
        regDate1.show()
        replyer.attr("readonly", true)
        regDate.attr("readonly", true)
        let rno = $(this).data("num")
        $.get("/replies/get/" + rno, function (data){
            console.log(data)
            replyText1.val(data.replyText)
            replyer1.val(data.replyer)
            regDate1.val(data.regDate)
            modal.data("rno", data.rno)
        })
    })




</script>

</body>
</html>